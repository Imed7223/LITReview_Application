{% extends 'base.html' %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
<div class="container mt-4">
    <!-- NAVIGATION -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm mb-4">
  <div class="container">
    <a class="navbar-brand fw-bold text-primary" href="#"><div class="card bg-light shadow-sm mb-4">
    <div class="card-body text-center">
        <h3 class="text-dark fw-bold m-0">üìä Tableau de bord</h3>
    </div>
  </div>
    </a>

    <div class="mx-auto d-flex align-items-center gap-2">
        <span style="color:black" class="badge bg-warning">Connect√© en tant que:<span  style="color:red"> {{ user.username }}</span></span>
      <form action="{% url 'logout' %}" method="POST" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger btn-sm">
          <i class="bi bi-box-arrow-right"></i> Se d√©connecter
        </button>
      </form>
    </div>

    <ul class="navbar-nav ms-auto">
      <li class="nav-item me-2">
        <a href="{% url 'create_ticket_and_review' %}" class="btn btn-success btn-sm">
          üé´‚úç Ticket + Critique
        </a>
      </li>
      <li class="nav-item">
        <a href="{% url 'create_ticket' %}" class="btn btn-outline-success btn-sm">
          üé´ Ticket seul
        </a>
      </li>
    </ul>
  </div>
</nav>

    <div class="row">
        <!-- Section Mes Tickets -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h3>Mes Tickets</h3>
                </div>
                <div class="card-body">
                    {% for ticket in tickets %}
                    <div class="mb-3 p-3 border rounded">
                        <h5>{{ ticket.title }}</h5>
                        <p>{{ ticket.description }}</p>
                        <small class="text-muted">Cr√©√© le {{ ticket.time_created|date:"d/m/Y H:i" }}</small>
                        <div class="mt-2">
                            <a href="{% url 'edit_ticket' ticket.id %}" class="btn btn-sm btn-warning">Modifier</a>
                            <a href="{% url 'delete_ticket' ticket.id %}" class="btn btn-sm btn-danger">Supprimer</a>
                        </div>
                    </div>
                    {% empty %}
                    <p>Aucun ticket cr√©√©.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Section Mes Critiques -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h3>Mes Critiques</h3>
                </div>
                <div class="card-body">
                    {% for review in reviews %}
                    <div class="mb-3 p-3 border rounded">
                        <h5>{{ review.headline }}</h5>
                        <div class="rating mb-2">
                            Note : {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}‚≠ê{% endif %}
                            {% endfor %} ({{ review.rating }}/5)
                        </div>
                        <p>{{ review.body }}</p>
                        <small class="text-muted">Post√© le {{ review.time_created|date:"d/m/Y H:i" }}</small>
                        <!-- Boutons modifier et supprimer -->
                <div class="mt-2">
                    <a href="{% url 'edit_review' review.id %}" class="btn btn-sm btn-warning">Modifier</a>
                    <a href="{% url 'delete_review' review.id %}" class="btn btn-sm btn-danger">Supprimer</a>
                </div>
                    </div>
                    {% empty %}
                    <p>Aucune critique post√©e.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Section Abonnements -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h3>Abonnements</h3>
        </div>
        <div class="card-body">
            {% for follow in follows %}
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                <span>{{ follow.followed_user.username }}</span>
                <a href="{% url 'unfollow_user' follow.id %}" class="btn btn-sm btn-outline-danger">Se d√©sabonner</a>
            </div>
            {% empty %}
            <p>Vous ne suivez personne actuellement.</p>
            {% endfor %}
            <a href="{% url 'follow_user' %}" class="btn btn-primary mt-2">Suivre un nouvel utilisateur</a>
        </div>
    </div>

    <!-- Section Flux -->
    <div class="card">
        <div class="card-header bg-light">
            <h3>Mon Flux</h3>
        </div>
        <div class="card-body">
            {% for post in posts %}
                {% if post.content_type == 'TICKET' %}
                <div class="mb-4 p-3 border rounded">
                    <div class="d-flex justify-content-between">
                        <h4>{{ post.title }}</h4>
                        <span class="badge bg-info">Ticket</span>
                    </div>
                    <p>{{ post.description }}</p>
                    {% if post.image %}
                        <img src="{{ post.image.url }}" alt="Image du ticket" class="img-fluid mb-2" style="max-height: 200px;">
                    {% endif %}
                    <small class="text-muted">Post√© par {{ post.user.username }} le {{ post.time_created|date:"d/m/Y H:i" }}</small>
                    <div class="mt-2">
                        <a href="{% url 'create_review_for_ticket' post.id %}" class="btn btn-sm btn-success">R√©pondre avec une critique</a>
                    </div>
                </div>
                {% elif post.content_type == 'REVIEW' %}
                <div class="mb-4 p-3 border rounded">
                    <div class="d-flex justify-content-between">
                        <h4>{{ post.headline }}</h4>
                        <span class="badge bg-success">Critique</span>
                    </div>
                    <div class="rating mb-2">
                        Note : {% for i in "12345" %}
                            {% if forloop.counter <= post.rating %}‚≠ê{% endif %}
                        {% endfor %} ({{ post.rating }}/5)
                    </div>
                    <p>{{ post.body }}</p>
                    <small class="text-muted">Critique post√©e par {{ post.user.username }} le {{ post.time_created|date:"d/m/Y H:i" }}</small>

                    <!-- Afficher le ticket associ√© -->
                    {% if post.ticket %}
                    <div class="mt-3 p-2 bg-light rounded">
                        <h5>Ticket : {{ post.ticket.title }}</h5>
                        <p>{{ post.ticket.description }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            {% empty %}
            <p>Aucun contenu √† afficher dans votre flux.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}